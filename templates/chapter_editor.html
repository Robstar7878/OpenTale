{% extends "base.html" %}
{% from "includes/quill_editor.html" import quill_editor %}

{% block title %}OpenTale - Chapter Editor - {{ chapter.chapter_number }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Review Chapter {{ chapter.chapter_number }}: {{ chapter.title }}</h2>
                <div>
                    <a href="/chapter/{{ chapter.chapter_number }}" class="btn btn-warning btn-sm">&laquo; Author Chapter View</a>
                    {% if chapter.chapter_number > 1 %}
                    <a href="/chapter_editor/{{ chapter.chapter_number - 1 }}" class="btn btn-light btn-sm">&laquo; Previous Chapter</a>
                    {% endif %}
                    {% if chapter.chapter_number < chapters|length %}
                    <a href="/chapter_editor/{{ chapter.chapter_number + 1 }}" class="btn btn-light btn-sm">Next Chapter &raquo;</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if not has_review %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>This chapter has not been reviewed yet.</strong> The content below is the original version. Use the editing tools, like `Execute Chapter Review`, to create the first review.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                <div class="row mb-2">
                    <div class="col-md-8">
                        <div class="accordion mb-4" id="chapterAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#outlineCollapse">
                                        Chapter Outline
                                    </button>
                                </h2>
                                <div id="outlineCollapse" class="accordion-collapse collapse" data-bs-parent="#chapterAccordion">
                                    <div class="accordion-body">
                                        <p>{{ chapter.prompt }}</p>
                                    </div>
                                </div>
                            </div>
                            {% if chapter.chapter_number > 1 %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#prevChapterCollapse">
                                        Previous Chapter Summary
                                    </button>
                                </h2>
                                <div id="prevChapterCollapse" class="accordion-collapse collapse" data-bs-parent="#chapterAccordion">
                                    <div class="accordion-body">
                                        <p><em>Automatically includes context from the previous chapter.</em></p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#masterPromptCollapse">
                                        Master Prompt (Optional) {% if master_prompt %}<span class="badge bg-success ms-2">Has Content</span>{% endif %}
                                    </button>
                                </h2>
                                <div id="masterPromptCollapse" class="accordion-collapse collapse" data-bs-parent="#chapterAccordion">
                                    <div class="accordion-body">
                                        <p class="small text-muted">Add a master prompt here to influence the entire chapter generation. This could be a style guide, a specific tone, or high-level instructions.</p>
                                        <textarea class="form-control" id="masterPrompt" name="master_prompt" rows="4">{{ master_prompt }}</textarea>
                                    </div>
                                </div>
                            </div>
                             <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#styleCollapse">
                                        Writing Style
                                    </button>
                                </h2>
                                <div id="styleCollapse" class="accordion-collapse collapse" data-bs-parent="#chapterAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="pointOfView" class="form-label">Point of View (POV)</label>
                                                <select class="form-select" id="pointOfView" name="point_of_view">
                                                    <option value="First-person limited" {% if point_of_view == 'First-person limited' %}selected{% endif %}>First-person limited</option>
                                                    <option value="Second-person" {% if point_of_view == 'Second-person' %}selected{% endif %}>Second-person</option>
                                                    <option value="Third-person limited" {% if point_of_view == 'Third-person limited' %}selected{% endif %}>Third-person limited</option>
                                                    <option value="Third-person omniscient" {% if point_of_view == 'Third-person omniscient' %}selected{% endif %}>Third-person omniscient</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="tense" class="form-label">Tense</label>
                                                <select class="form-select" id="tense" name="tense">
                                                    <option value="Past tense" {% if tense == 'Past tense' %}selected{% endif %}>Past tense</option>
                                                    <option value="Present tense" {% if tense == 'Present tense' %}selected{% endif %}>Present tense</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#actionBeatsCollapse">
                                        Action Beats (Optional) {% if action_beats_content %}<span class="badge bg-success ms-2">Has Content</span>{% endif %}
                                    </button>
                                </h2>
                                <div id="actionBeatsCollapse" class="accordion-collapse collapse" data-bs-parent="#chapterAccordion">
                                    <div class="accordion-body">
                                        <div id="actionBeatsContainer">
                                            {% if action_beats_content %}
                                                <form id="saveActionBeatsForm" action="/save_action_beats/{{ chapter.chapter_number }}" method="post">
                                                    <div class="mb-3">
                                                        {{ quill_editor('actionBeatsEditor', 'action_beats_content', action_beats_content) }}
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <button type="submit" class="btn btn-success btn-sm" id="saveActionBeatsBtn">Save Action Beats</button>
                                                        <a href="/action_beats_chat/{{ chapter.chapter_number }}" class="btn btn-warning btn-sm">Go To Action Beats Editor</a>
                                                    </div>
                                                </form>
       
                                                <div id="savingActionBeatsIndicator" class="alert alert-info mt-3 d-none">
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <div>Saving Action Beats...</div>
                                                    </div>
                                                </div>
                                            
                                                <div id="savedActionBeatsIndicator" class="alert alert-success mt-3 d-none">
                                                    <div>Action Beats saved successfully!</div>
                                                </div>
                                            {% else %}
                                                <div class="d-flex justify-content-center">
                                                    <a href="/action_beats_chat/{{ chapter.chapter_number }}" class="btn btn-warning">Go To Action Beats Editor</a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat interface for chapter development -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h3 class="h5 mb-0">Chapter Editing Chat</h3>
                            </div>
                            <div class="card-body">
                                <div id="chatMessages" class="p-3 mb-3 border rounded" style="height: 300px; overflow-y: auto;">
                                    <div class="text-center p-3">
                                        <p>Use this chat to provide specific editing instructions. For example, "Make the opening more dramatic," or "Shorten the dialogue in the second half."</p>
                                    </div>
                                </div>

                                <div class="d-flex">
                                    <input type="text" id="userMessage" class="form-control me-2" placeholder="Add editing instructions...">
                                    <button id="sendMessageBtn" class="btn btn-primary">Send</button>
                                </div>

                                <div class="mt-3 d-flex">
                                    <button type="button" class="btn btn-warning me-2" id="executeChapterReviewBtn">Execute Chapter Review</button>
                                    <button type="button" class="btn btn-info" id="showPromptBtn">Show Execute Chapter Review Prompt</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info d-none">
                            <strong>Tips for Chapter Editing:</strong>
                            <ul class="small mb-0">
                                <li>Focus on improving clarity and flow.</li>
                                <li>Check for consistent character voice.</li>
                                <li>Strengthen descriptive language.</li>
                                <li>Ensure dialogue feels natural.</li>
                                <li>Look for plot holes or inconsistencies.</li>
                            </ul>
                        </div>
                        
                        {% set is_editor_view = True %}
                        {% include 'includes/chapter_navigation_side.html' %}

                    </div>
                </div>

                <div id="generatingIndicator" class="alert alert-info mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Editing chapter content... This may take several minutes.</div>
                    </div>
                </div>

                <div id="chapterContentContainer" {% if not original_chapter_content %}class="d-none"{% endif %}>
                    <!-- Original Chapter Content -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0">Original Chapter Content (Read-Only)</h3>
                            <div class="d-flex text-end">
                                <div class="me-3" style="line-height: 1;">
                                    <small class="text-muted" style="font-size: 0.7em;">Words</small>
                                    <div id="originalWordCount" class="h5 mb-0">0</div>
                                </div>
                                <div class="me-3" style="line-height: 1;">
                                    <small class="text-muted" style="font-size: 0.7em;">Characters</small>
                                    <div id="originalCharCount" class="h5 mb-0">0</div>
                                </div>
                                <div style="line-height: 1;">
                                    <small class="text-muted" style="font-size: 0.7em;">Sentences</small>
                                    <div id="originalSentenceCount" class="h5 mb-0">0</div>
                                </div>
                            </div>
                        </div>
                        {{ quill_editor('originalChapterContentEditor', 'original_chapter_content', original_chapter_content) }}
                    </div>

                    <!-- Editor Review Content -->
                    <form id="saveChapterForm" action="/save_chapter_editor/{{ chapter.chapter_number }}" method="post">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="h5 mb-0">Editor Review Content</h3>
                                <div class="d-flex text-end">
                                    <div class="me-3" style="line-height: 1;">
                                        <small class="text-muted" style="font-size: 0.7em;">Words</small>
                                        <div id="wordCount" class="h5 mb-0">0</div>
                                    </div>
                                    <div class="me-3" style="line-height: 1;">
                                        <small class="text-muted" style="font-size: 0.7em;">Characters</small>
                                        <div id="charCount" class="h5 mb-0">0</div>
                                    </div>
                                    <div style="line-height: 1;">
                                        <small class="text-muted" style="font-size: 0.7em;">Sentences</small>
                                        <div id="sentenceCount" class="h5 mb-0">0</div>
                                    </div>
                                </div>
                            </div>
                            {{ quill_editor('chapterContentEditor', 'chapter_content', chapter_content) }}
                        </div>
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-success" id="saveChapterBtn">Save Chapter Review Content</button>
                                <a href="/chapter/{{ chapter.chapter_number }}" class="btn btn-warning">Return to Chapter View</a>
                            </div>
                            <div>
                                {% if chapter.chapter_number > 1 %}
                                <a href="/chapter_editor/{{ chapter.chapter_number - 1 }}" class="btn btn-primary">&laquo; Previous Chapter</a>
                                {% endif %}
                                {% if chapter.chapter_number < chapters|length %}
                                <a href="/chapter_editor/{{ chapter.chapter_number + 1 }}" class="btn btn-primary">Next Chapter &raquo;</a>
                                {% else %}
                                <a href="/outline" class="btn btn-primary">Back to Outline</a>
                                {% endif %}
                            </div>
                        </div>
                    </form>

                    <div id="savingIndicator" class="alert alert-info mt-3 d-none">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>Saving chapter review...</div>
                        </div>
                    </div>

                    <div id="savedIndicator" class="alert alert-success mt-3 d-none">
                        <div>Chapter review saved successfully!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Chat history
    let chatHistory = [];

    // Send user message
    $('#sendMessageBtn').click(function() {
        sendUserMessage();
    });

    // Also send message when user presses Enter
    $('#userMessage').keypress(function(e) {
        if (e.which === 13) {
            sendUserMessage();
            e.preventDefault();
        }
    });

    function sendUserMessage() {
        const message = $('#userMessage').val().trim();
        if (!message) return;

        // Add user message to chat
        addMessageToChat('user', message);

        // Clear input field
        $('#userMessage').val('');

        // Update chat history
        chatHistory.push({role: 'user', content: message});

        // For simplicity, we'll provide a standard response about using the input for chapter generation
        const response = "Thanks for the feedback! I'll use this when you apply edits. Feel free to add more instructions.";

        // Add AI response to chat after a short delay to simulate thinking
        setTimeout(function() {
            addMessageToChat('ai', response);
            // Add to chat history
            chatHistory.push({role: 'ai', content: response});
        }, 500);
    }

    // Edit chapter
    $('#executeChapterReviewBtn').click(function() {
        $('#generatingIndicator').removeClass('d-none');
        $(this).prop('disabled', true);

        // Get any additional context from chat
        const additionalContext = chatHistory.length > 0
            ? "\n\nAdditional user requirements:\n" +
              chatHistory.filter(msg => msg.role === 'user')
                        .map(msg => "- " + msg.content)
                        .join("\n")
            : "";

        const masterPrompt = $('#masterPrompt').val();
        const pointOfView = $('#pointOfView').val();
        const tense = $('#tense').val();
        const action_beats_content = $('#actionBeatsEditor-hidden').val();
        const chapterContent = $('#originalChapterContentEditor-hidden').val(); // Use original content for editing

        const requestData = {
            additional_context: additionalContext,
            master_prompt: masterPrompt,
            point_of_view: pointOfView,
            tense: tense,
            action_beats_content: action_beats_content,
            chapter_content: chapterContent // This is the original content
        };

        let fullContent = '';
        const chapterContentEditorElement = document.getElementById('chapterContentEditor');
        const chapterQuill = chapterContentEditorElement ? chapterContentEditorElement.quill : null;
        if(chapterQuill) {
            chapterQuill.setText('');
        }

        fetch(`/chapter_editor_stream/{{ chapter.chapter_number }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        }).then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function readStream() {
                return reader.read().then(({ value, done }) => {
                    if (done) {
                        // End of stream
                        $('#generatingIndicator').addClass('d-none');
                        $('#executeChapterReviewBtn').prop('disabled', false);
                        updateContentStats();

                        // Reset chat history after generating
                        chatHistory = [];
                        $('#chatMessages').html('<div class="text-center p-3"><p>Chapter has been edited! You can continue to add details or make changes to refine it further.</p></div>');
                        return;
                    }

                    // Decode the chunk
                    const chunk = decoder.decode(value);

                    // Process each event in the chunk
                    chunk.split('\n\n').forEach(event => {
                        if (event.startsWith('data: ')) {
                            try {
                                const jsonData = event.substring(6); // Remove 'data: ' prefix
                                const data = JSON.parse(jsonData);

                                if (data.content === '[DONE]') {
                                    // This will be handled by the done flag
                                    return;
                                }

                                if (data.content) {

                                    // Append new content
                                    fullContent += data.content;

                                    // Update the Quill editor with all content so far
                                    if(chapterContentEditorElement && chapterContentEditorElement.quillHandler) {
                                        chapterContentEditorElement.quillHandler.updateEditorWithMarkdown(fullContent);
                                    }
                                    $('#chapterContentContainer').removeClass('d-none');
                                }
                            } catch (e) {
                                console.error('Error parsing JSON:', e, jsonData);
                            }
                        }
                    });
                    return readStream();
                });
            }
            return readStream();
        }).catch(error => {
            console.error('Fetch error:', error);
            alert('Error editing chapter. Please try again.');
            $('#generatingIndicator').addClass('d-none');
            $('#executeChapterReviewBtn').prop('disabled', false);
        });
    });

    // Add message to chat display
    function addMessageToChat(sender, message) {
        const messageDiv = $('<div>').addClass('mb-3');

        if (sender === 'user') {
            messageDiv.addClass('text-end');
            const messageBubble = $('<div>').addClass('d-inline-block bg-primary text-white p-2 rounded-3')
                                            .css('max-width', '80%')
                                            .html(formatMessage(message));
            messageDiv.append(messageBubble);
        } else if (sender === 'ai') {
            messageDiv.addClass('text-start');
            const messageBubble = $('<div>').addClass('d-inline-block bg-light p-2 rounded-3')
                                            .css('max-width', '80%')
                                            .html(formatMessage(message));
            messageDiv.append(messageBubble);
        } else {
            // System message
            messageDiv.addClass('text-center');
            const messageBubble = $('<div>').addClass('d-inline-block bg-warning p-2 rounded-3')
                                            .text(message);
            messageDiv.append(messageBubble);
        }

        $('#chatMessages').append(messageDiv);

        // Scroll to bottom
        $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    }

    // Format message with line breaks
    function formatMessage(message) {
        return message.replace(/\n/g, '<br>');
    }

    // Save chapter
    $('#saveChapterForm').submit(function(e) {
        e.preventDefault();
        $('#savingIndicator').removeClass('d-none');
        $('#savedIndicator').addClass('d-none');
        $('#saveChapterBtn').prop('disabled', true);

        $.ajax({
            type: 'POST',
            url: '/save_chapter_editor/{{ chapter.chapter_number }}',
            data: $(this).serialize(),
            success: function() {
                $('#savingIndicator').addClass('d-none');
                $('#savedIndicator').removeClass('d-none');
                $('#saveChapterBtn').prop('disabled', false);

                // Hide the saved indicator after 3 seconds
                setTimeout(function() {
                    $('#savedIndicator').addClass('d-none');
                }, 3000);
            },
            error: function() {
                alert('Error saving chapter. Please try again.');
                $('#savingIndicator').addClass('d-none');
                $('#saveChapterBtn').prop('disabled', false);
            }
        });
    });

    // Save Action Beats
    $('#saveActionBeatsForm').submit(function(e) {
        e.preventDefault();
        $('#savingActionBeatsIndicator').removeClass('d-none');
        $('#savedActionBeatsIndicator').addClass('d-none');
        $('#saveActionBeatsBtn').prop('disabled', true);
        
        $.ajax({
            type: 'POST',
            url: `/save_action_beats/{{ chapter.chapter_number }}`,
            data: $(this).serialize(),
            success: function() {
                $('#savingActionBeatsIndicator').addClass('d-none');
                $('#savedActionBeatsIndicator').removeClass('d-none');
                $('#saveActionBeatsBtn').prop('disabled', false);
                
                // Hide the saved indicator after 3 seconds
                setTimeout(function() {
                    $('#savedActionBeatsIndicator').addClass('d-none');
                }, 3000);
            },
            error: function() {
                alert('Error saving action beats. Please try again.');
                $('#savingActionBeatsIndicator').addClass('d-none');
                $('#saveActionBeatsBtn').prop('disabled', false);
            }
        });
    });

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    // Update content stats
    function updateContentStats() {
        const chapterContentEditorElement = document.getElementById('chapterContentEditor');
        const chapterQuill = chapterContentEditorElement ? chapterContentEditorElement.quill : null;
        if (chapterQuill) {
            const content = chapterQuill.getText();
            const stats = calculateTextStats(content);
            $('#wordCount').text(stats.wordCount);
            $('#charCount').text(stats.charCount);
            $('#sentenceCount').text(stats.sentenceCount);
        }
    }

    // Update original content stats
    function updateOriginalContentStats() {
        const originalChapterContentEditorElement = document.getElementById('originalChapterContentEditor');
        const originalChapterQuill = originalChapterContentEditorElement ? originalChapterContentEditorElement.quill : null;
        if (originalChapterQuill) {
            const content = originalChapterQuill.getText();
            const stats = calculateTextStats(content);
            $('#originalWordCount').text(stats.wordCount);
            $('#originalCharCount').text(stats.charCount);
            $('#originalSentenceCount').text(stats.sentenceCount);
        }
    }

    // Initial calculation
    updateContentStats();
    updateOriginalContentStats();

    // Update on keyup
    const chapterContentEditorElement = document.getElementById('chapterContentEditor');
    const chapterQuill = chapterContentEditorElement ? chapterContentEditorElement.quill : null;
    if(chapterQuill) {
        chapterQuill.on('text-change', debounce(updateContentStats, 250));
    }

    // Save master prompt with debounce
    const saveMasterPrompt = debounce(function() {
        const masterPrompt = $('#masterPrompt').val();
        $.ajax({
            type: 'POST',
            url: '/save_master_prompt',
            data: {
                master_prompt: masterPrompt
            },
            success: function() {
                // Optional: show a success indicator
                console.log('Master prompt saved.');
            },
            error: function() {
                // Optional: show an error indicator
                console.error('Error saving master prompt.');
            }
        });
    }, 500); // 500ms delay

    $('#masterPrompt').on('keyup', saveMasterPrompt);

    // Show prompt
    $('#showPromptBtn').click(function() {
        const additionalContext = chatHistory.length > 0
            ? "\n\nAdditional user requirements:\n" +
              chatHistory.filter(msg => msg.role === 'user')
                        .map(msg => "- " + msg.content)
                        .join("\n")
            : "";
        
        const masterPrompt = $('#masterPrompt').val();
        const pointOfView = $('#pointOfView').val();
        const tense = $('#tense').val();
        const action_beats_content = $('#actionBeatsEditor-hidden').val();
        const chapterContent = $('#originalChapterContentEditor-hidden').val();

        const requestData = {
            additional_context: additionalContext,
            master_prompt: masterPrompt,
            point_of_view: pointOfView,
            tense: tense,
            action_beats_content: action_beats_content,
            chapter_content: chapterContent,
            show_prompt: true
        };

        fetch(`/chapter_editor_stream/{{ chapter.chapter_number }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.prompt) {
                showModalWithContent('Chapter Editing Prompt', data.prompt);
            } else {
                alert('Error fetching prompt.');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Error fetching prompt. Please try again.');
        });
    });
});
</script>
{% endblock %}