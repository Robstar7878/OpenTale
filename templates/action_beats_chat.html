{% extends "base.html" %}

{% block title %}OpenTale - Action Beats Chat for Chapter {{ chapter.chapter_number }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Action Beats Chat for Chapter {{ chapter.chapter_number }}: {{ chapter.title }}</h2>
                <div>
                    <a href="/chapter/{{ chapter.chapter_number }}" class="btn btn-primary btn-sm">&laquo; Back to Chapter</a>
                    {% if chapter.chapter_number > 1 %}
                    <a href="/action_beats_chat/{{ chapter.chapter_number - 1 }}" class="btn btn-light btn-sm">&laquo; Previous Chapter</a>
                    {% endif %}
                    {% if chapter.chapter_number < chapters|length %}
                    <a href="/action_beats_chat/{{ chapter.chapter_number + 1 }}" class="btn btn-light btn-sm">Next Chapter &raquo;</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if not action_beats_content %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <strong>No action beats generated yet.</strong> Use the chat below to generate the first set of action beats for this chapter.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                <div class="mb-4">
                    <h3 class="h5">Chapter Summary:</h3>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0">{{ chapter.prompt[:200] }}{% if chapter.prompt|length > 200 %}...{% endif %}</p>
                            <button class="btn btn-sm btn-outline-secondary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#fullChapterSummary">
                                Show Full Chapter Summary
                            </button>
                            <div class="collapse mt-2" id="fullChapterSummary">
                                <div class="card card-body">
                                    {{ chapter.prompt }}
                                </div>
                            </div>
                        </div>
                    </div>

                <p class="lead">Chat with the AI to develop your chapter's action beats. Describe your ideas for action sequences, answer questions, and refine the pacing together.</p>
                
                <div class="mb-3">
                    <label for="numBeats" class="form-label">How many action beats would you like to generate?</label>
                    <input type="number" class="form-control" id="numBeats" name="num_beats" min="1" max="20" value="12">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat interface -->
    <div class="col-12 mb-4" id="chatContainer" data-chapter-number="{{ chapter.chapter_number }}">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0">Action Beats Development Chat</h3>
            </div>
            <div class="card-body">
                <div id="chatMessages" class="p-3 mb-3 border rounded" style="height: 400px; overflow-y: auto;">
                    <div class="text-center p-3">
                        <p>Tell me about the action sequences you envision for this chapter. What key moments or movements should be included?</p>
                    </div>
                </div>
                
                <div class="d-flex">
                    <input type="text" id="userMessage" class="form-control me-2" placeholder="Type your ideas about action beats you want to create...">
                    <button id="sendMessageBtn" class="btn btn-primary">Send</button>
                </div>
                
                {% if not action_beats_content %}
                <div class="alert alert-info mt-3">
                    <h5 class="alert-heading">How to Generate Action Beats</h5>
                    <p>You have two main options for generating the action beats for this chapter:</p>
                    <hr>
                    <p class="mb-1"><strong>1. Use the Chat for Detailed Guidance:</strong></p>
                    <p class="small">Engage in a conversation in the chat below. Provide specific ideas, scenes, or character interactions. Your entire chat history, along with world, character, and previous chapter context, will be used to create a detailed set of action beats tailored to your input.</p>
                    
                    <p class="mb-1"><strong>2. Generate Directly:</strong></p>
                    <p class="small">If you prefer a quicker start, simply click the "Generate Action Beats" button. The AI will automatically create a set of action beats based on the chapter summary, world and character context, a summary of the previous chapter, and the requested number of beats.</p>
                </div>
                {% endif %}
                <div class="mt-3">
                    <button id="finalizeChatBtn" class="btn btn-success">
                        {% if action_beats_content %}Regenerate Action Beats{% else %}Generate Action Beats{% endif %}
                    </button>
                </div>
                
                <div id="chatTypingIndicator" class="alert alert-info mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>AI is thinking...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12" id="actionBeatsResultContainer" style="display: none;">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h3 class="h5 mb-0">Your Action Beats</h3>
            </div>
            <div class="card-body">
                <form id="saveActionBeatsForm" action="/save_action_beats/{{ chapter.chapter_number }}" method="post">
                    <div class="mb-3">
                        <label for="actionBeatsContent" class="form-label">Edit your action beats if needed:</label>
                        <textarea class="form-control" id="actionBeatsContent" name="action_beats_content" rows="15">{{ action_beats_content }}</textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-success" id="saveActionBeatsBtn">Save Changes</button>
                        <a href="/chapter/{{ chapter.chapter_number }}" class="btn btn-primary">Return to Chapter</a>
                    </div>
                </form>
                
                <div id="savingIndicator" class="alert alert-info mt-3 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Saving changes...</div>
                    </div>
                </div>
                
                <div id="savedIndicator" class="alert alert-success mt-3 d-none">
                    <div>Action beats saved successfully!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const chapterNumber = $('#chatContainer').data('chapter-number');
    let chatHistory = [];

    // Show action beats result container if content exists
    const existingActionBeats = $('#actionBeatsContent').val().trim();
    if (existingActionBeats) {
        $('#actionBeatsResultContainer').show();
    }

    // Save numBeats on change
    $('#numBeats').on('change', function() {
        const numBeats = $(this).val();
        $.ajax({
            type: 'POST',
            url: '/save_setting',
            contentType: 'application/json',
            data: JSON.stringify({ key: 'num_beats', value: numBeats }),
            error: function() {
                console.error('Error saving num_beats');
            }
        });
    });
    
    // Send user message
    $('#sendMessageBtn').click(function() {
        sendUserMessage();
    });
    
    // Also send message when user presses Enter
    $('#userMessage').keypress(function(e) {
        if (e.which === 13) {
            sendUserMessage();
            e.preventDefault();
        }
    });
    
    function sendUserMessage() {
        const message = $('#userMessage').val().trim();
        if (!message) return;
        
        // Add user message to chat
        addMessageToChat('user', message);
        
        // Clear input field
        $('#userMessage').val('');
        
        // Show AI is thinking
        $('#chatTypingIndicator').removeClass('d-none');
        
        // Update chat history
        chatHistory.push({role: 'user', content: message});
        
        // Create a message div for the AI response
        const messageDiv = $('<div>').addClass('mb-3 text-start');
        const messageBubble = $('<div>')
            .addClass('d-inline-block bg-light p-2 rounded-3')
            .css('max-width', '80%')
            .html('<span class="typing-cursor">â–Œ</span>');
        messageDiv.append(messageBubble);
        $('#chatMessages').append(messageDiv);
        
        // Scroll to bottom
        $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
        
        // Prepare request data
        const requestData = {
            message: message,
            chat_history: chatHistory.slice(0, -1), // Exclude current message
            chapter_number: chapterNumber
        };
        
        // Initialize response content
        let responseContent = '';
        
        // Make the streaming request with fetch
        fetch(`/action_beats_chat_stream/${chapterNumber}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        }).then(response => {
            // Use a ReadableStream to process the streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                return reader.read().then(({ value, done }) => {
                    if (done) {
                        // End of stream
                        $('#chatTypingIndicator').addClass('d-none');
                        // Update chat history with complete response
                        chatHistory.push({role: 'ai', content: responseContent});
                        // Remove typing cursor
                        messageBubble.find('.typing-cursor').remove();
                        return;
                    }
                    
                    // Decode the chunk
                    const chunk = decoder.decode(value);
                    
                    // Process each event in the chunk
                    chunk.split('\n\n').forEach(event => {
                        if (event.startsWith('data: ')) {
                            try {
                                const jsonData = event.substring(6); // Remove 'data: ' prefix
                                const data = JSON.parse(jsonData);
                                
                                if (data.content === '[DONE]') {
                                    // This will be handled by the done flag
                                    return;
                                }
                                
                                // Append new content to response
                                responseContent += data.content;
                                
                                // Update the message bubble with formatted content
                                messageBubble.html(formatMessage(responseContent) + '<span class="typing-cursor">â–Œ</span>');
                                
                                // Scroll to bottom as content arrives
                                $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                            } catch (e) {
                                console.error('Error parsing JSON:', e, jsonData);
                            }
                        }
                    });
                    
                    // Continue reading
                    return readStream();
                });
            }
            
            // Start reading the stream
            return readStream();
        }).catch(error => {
            console.error('Fetch error:', error);
            $('#chatTypingIndicator').addClass('d-none');
            addMessageToChat('system', 'Error streaming response. Please try again.');
        });
    }
    
    // Finalize action beats
    $('#finalizeChatBtn').click(function() {
        // Show AI is thinking
        $('#chatTypingIndicator').removeClass('d-none');
        
        // Disable button
        $(this).prop('disabled', true);
        
        // Prepare the textarea in the result container
        $('#actionBeatsContent').val('');
        
        // Show result container
        $('#actionBeatsResultContainer').show();
        
        // Create a typing cursor for streaming effect
        let actionBeatsText = '';
        const actionBeatsTextarea = $('#actionBeatsContent');
        actionBeatsTextarea.val('');
        
        // Make a streaming request for the final action beats
        fetch(`/finalize_action_beats_stream/${chapterNumber}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_history: chatHistory,
                num_beats: $('#numBeats').val(),
                chapter_number: chapterNumber
            })
        }).then(response => {
            // Process the streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                return reader.read().then(({ value, done }) => {
                    if (done) {
                        // End of stream
                        $('#chatTypingIndicator').addClass('d-none');
                        $('#finalizeChatBtn').prop('disabled', false);
                        return;
                    }
                    
                    // Decode the chunk
                    const chunk = decoder.decode(value);
                    
                    // Process each event in the chunk
                    chunk.split('\n\n').forEach(event => {
                        if (event.startsWith('data: ')) {
                            try {
                                const jsonData = event.substring(6); // Remove 'data: ' prefix
                                const data = JSON.parse(jsonData);
                                
                                if (data.content === '[DONE]') {
                                    // Streaming complete
                                    return;
                                }
                                
                                // Append new content
                                actionBeatsText += data.content;
                                
                                // Update the textarea with all content so far
                                actionBeatsTextarea.val(actionBeatsText);
                                
                                // Scroll textarea to bottom to follow updates
                                actionBeatsTextarea.scrollTop(actionBeatsTextarea[0].scrollHeight);
                            } catch (e) {
                                console.error('Error parsing JSON:', e, jsonData);
                            }
                        }
                    });
                    
                    // Continue reading
                    return readStream();
                });
            }
            
            // Start reading the stream
            return readStream();
        }).catch(error => {
            console.error('Fetch error for final action beats:', error);
            $('#chatTypingIndicator').addClass('d-none');
            $('#finalizeChatBtn').prop('disabled', false);
            alert('Error finalizing action beats. Please try again.');
        });
    });
    
    // Add message to chat display
    function addMessageToChat(sender, message) {
        const messageDiv = $('<div>').addClass('mb-3');
        
        if (sender === 'user') {
            messageDiv.addClass('text-end');
            const messageBubble = $('<div>').addClass('d-inline-block bg-primary text-white p-2 rounded-3')
                                            .css('max-width', '80%')
                                            .html(formatMessage(message));
            messageDiv.append(messageBubble);
        } else if (sender === 'ai') {
            messageDiv.addClass('text-start');
            const messageBubble = $('<div>').addClass('d-inline-block bg-light p-2 rounded-3')
                                            .css('max-width', '80%')
                                            .html(formatMessage(message));
            messageDiv.append(messageBubble);
        } else {
            // System message
            messageDiv.addClass('text-center');
            const messageBubble = $('<div>').addClass('d-inline-block bg-warning p-2 rounded-3')
                                            .text(message);
            messageDiv.append(messageBubble);
        }
        
        $('#chatMessages').append(messageDiv);
        
        // Scroll to bottom
        $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    }
    
    // Format message with line breaks
    function formatMessage(message) {
        return message.replace(/\n/g, '<br>');
    }
    
    // Save action beats
    $('#saveActionBeatsForm').submit(function(e) {
        e.preventDefault();
        $('#savingIndicator').removeClass('d-none');
        $('#savedIndicator').addClass('d-none');
        $('#saveActionBeatsBtn').prop('disabled', true);
        
        $.ajax({
            type: 'POST',
            url: `/save_action_beats/${chapterNumber}`,
            data: $(this).serialize(),
            success: function() {
                $('#savingIndicator').addClass('d-none');
                $('#savedIndicator').removeClass('d-none');
                $('#saveActionBeatsBtn').prop('disabled', false);
                
                // Hide the saved indicator after 3 seconds
                setTimeout(function() {
                    $('#savedIndicator').addClass('d-none');
                }, 3000);
            },
            error: function() {
                alert('Error saving action beats. Please try again.');
                $('#savingIndicator').addClass('d-none');
                $('#saveActionBeatsBtn').prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}